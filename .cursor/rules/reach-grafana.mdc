---
description: Use grafana to get a distributed training's logs
globs: 
alwaysApply: false
---
# Grafana use

In Grafana you can query logs of any run.
A training / inference request can yield several
runs. To get the identifier which is the `run_name`,
you should use Github actions' run and the outputs of 
the step `setup-training-run`.

Then:
```python
import requests
import os

token = os.environ["GRAFANA_TOKEN"]
event_type = "training" # or inference
run_name = "your-run-name"
LOKI_DATA_SOURCE_ID = "e2c4d0a3-a4b5-40c3-8ecd-ccc601515a1c"
EXPR = (
    "environment=\"deep-learning\", event=\"{event_type}\", name=\"{run_name}\"".format(
        event_type=event_type, run_name=run_name)
)
EXPR = '{' + EXPR + '}'

requests.post(
    url=f"{self.api_url}/ds/query",
    headers={"Authorization": f"Bearer {token}"},
    json={
        "queries": [
            {
                "refId": "A",
                "datasource": {"uid": LOKI_DATA_SOURCE_UID},
                "expr": EXPR,
                "format": "logs",
                "intervalMs": 1000,
                "maxDataPoints": 500,
            }
        ],
        "range": {
            "from": "now-1h",
            "to": "now"
        }
    }
    timeout=20,
)
```
